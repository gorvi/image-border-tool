"""
ä¸»çª—å£æ¨¡å—
"""

import tkinter as tk
from tkinter import ttk, filedialog, messagebox
from PIL import Image
import os
from datetime import datetime

from canvas_widget import CanvasWidget
from image_processor import ImageProcessor, CompositeImage
from constants import (SIZE_PRESETS, BORDER_STYLES, STICKER_LIST, COLORS, 
                      BORDER_STYLES_WITH_PREVIEW, BORDER_CATEGORIES, 
                      BORDER_COLORS, BORDER_STYLE_NAMES,
                      BORDER_SHAPES, BORDER_LINE_STYLES, DEFAULT_BACKGROUNDS)
from color_picker import ColorPicker
from PIL import Image, ImageTk


class MainWindow(tk.Tk):
    """ä¸»çª—å£ç±»"""
    
    def __init__(self):
        super().__init__()
        
        self.title('å›¾ç‰‡å¥—ç‰ˆå·¥å…·')
        
        # è·å–å±å¹•å°ºå¯¸å¹¶è®¾ç½®çª—å£å¤§å°ï¼ˆå±å¹•çš„80%ï¼‰
        screen_width = self.winfo_screenwidth()
        screen_height = self.winfo_screenheight()
        window_width = int(screen_width * 0.85)
        window_height = int(screen_height * 0.85)
        
        # å±…ä¸­æ˜¾ç¤º
        x = (screen_width - window_width) // 2
        y = (screen_height - window_height) // 2
        
        self.geometry(f'{window_width}x{window_height}+{x}+{y}')
        self.minsize(1200, 700)  # æœ€å°çª—å£å°ºå¯¸
        self.configure(bg=COLORS['bg'])
        
        # åˆå§‹åŒ–å˜é‡
        self.image_processor = ImageProcessor()
        self.current_size_preset = SIZE_PRESETS[2]  # é»˜è®¤æ­£æ–¹å½¢
        self.current_border = BORDER_STYLES[0]  # é»˜è®¤æ— è¾¹æ¡†
        self.batch_images = []  # æ‰¹é‡å›¾ç‰‡åˆ—è¡¨
        self.sticker_images = {}  # ç¼“å­˜è´´çº¸å›¾ç‰‡
        self.border_preview_images = {}  # ç¼“å­˜è¾¹æ¡†é¢„è§ˆå›¾
        self.sticker_photo_refs = []  # ä¿æŒå›¾ç‰‡å¼•ç”¨ï¼Œé˜²æ­¢è¢«åƒåœ¾å›æ”¶
        self.border_photo_refs = []  # ä¿æŒè¾¹æ¡†å›¾ç‰‡å¼•ç”¨
        
        # è¾¹æ¡†é€‰æ‹©çŠ¶æ€ï¼ˆæ—§ç‰ˆï¼‰
        self.selected_border_category = 'modern'
        self.selected_border_color = 'black'
        
        # è‡ªå®šä¹‰è¾¹æ¡†é…ç½®
        self.border_config = {
            'shape': 'rectangle',
            'line_style': 'solid',
            'width': 10,
            'radius': 0,
            'color': '#000000',
            'gradient': False,
        }
        
        # èƒŒæ™¯é…ç½®
        self.background_color = '#FFFFFF'
        self.background_image = None
        
        # åŠ è½½èµ„æº
        self.load_sticker_images()
        self.load_border_preview_images()
        
        # å†å²è®°å½•
        self.history = []
        self.history_index = -1
        
        # åˆ›å»ºUI
        self.create_widgets()
        
        # ç»‘å®šå¿«æ·é”®
        self.bind('<Command-z>', lambda e: self.undo())
        self.bind('<Command-Shift-Z>', lambda e: self.redo())
        self.bind('<Command-s>', lambda e: self.export_image())
        self.bind('<Configure>', self.on_window_resize)
    
    def on_window_resize(self, event):
        """çª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´ç”»å¸ƒ"""
        if event.widget == self:
            # å»¶è¿Ÿè°ƒæ•´ï¼Œé¿å…é¢‘ç¹è§¦å‘
            if hasattr(self, 'resize_timer'):
                self.after_cancel(self.resize_timer)
            self.resize_timer = self.after(100, self.adjust_canvas_display)
    
    def adjust_canvas_display(self):
        """è‡ªé€‚åº”è°ƒæ•´ç”»å¸ƒæ˜¾ç¤º"""
        try:
            if hasattr(self, 'canvas_widget') and hasattr(self, 'center_panel'):
                # è·å–ä¸­é—´é¢æ¿å®é™…å¤§å°
                self.update_idletasks()
                # ç”»å¸ƒä¼šè‡ªåŠ¨é€‚åº”ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒæ•´
        except:
            pass
        
    def create_widgets(self):
        """åˆ›å»ºç•Œé¢ç»„ä»¶ - æ¯›ç»ç’ƒé£æ ¼"""
        # ä¸»å®¹å™¨
        main_container = tk.Frame(self, bg=COLORS['bg'])
        main_container.pack(fill=tk.BOTH, expand=True)
        
        # å·¦ä¾§å¯æŠ˜å é¢æ¿å®¹å™¨
        self.left_container = tk.Frame(main_container, bg=COLORS['bg'])
        self.left_container.pack(side=tk.LEFT, fill=tk.Y)
        
        # å·¦ä¾§é¢æ¿æ¡†æ¶
        self.left_panel_frame = tk.Frame(self.left_container, bg=COLORS['bg'])
        self.left_panel_frame.pack(side=tk.LEFT, fill=tk.Y)
        
        self.left_panel = self.create_left_panel(self.left_panel_frame)
        self.left_panel.pack(fill=tk.BOTH, expand=True, padx=(8, 0), pady=8)
        
        # æŠ˜å æŒ‰é’®
        self.collapse_btn = tk.Button(
            self.left_container,
            text='â—€',
            command=self.toggle_left_panel,
            font=('SF Pro Text', 16),
            bg=COLORS['panel_bg'],
            fg=COLORS['text_secondary'],
            activebackground=COLORS['hover'],
            relief=tk.FLAT,
            width=2,
            cursor='hand2',
            bd=0,
            highlightthickness=1,
            highlightbackground=COLORS['separator'],
            highlightcolor=COLORS['separator']
        )
        self.collapse_btn.pack(side=tk.RIGHT, fill=tk.Y, padx=(4, 0))
        
        self.left_panel_visible = True
        
        # ä¸­é—´ç”»å¸ƒåŒºåŸŸ
        self.center_panel = self.create_center_panel(main_container)
        self.center_panel.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=8, pady=8)
        
        # å³ä¾§é¢æ¿
        self.right_panel = self.create_right_panel(main_container)
        self.right_panel.pack(side=tk.RIGHT, fill=tk.Y, padx=(0, 8), pady=8)
    
    def toggle_left_panel(self):
        """åˆ‡æ¢å·¦ä¾§é¢æ¿æ˜¾ç¤º/éšè—"""
        if self.left_panel_visible:
            # éšè—
            self.left_panel_frame.pack_forget()
            self.collapse_btn.config(text='â–¶')
            self.left_panel_visible = False
        else:
            # æ˜¾ç¤º
            self.left_panel_frame.pack(side=tk.LEFT, fill=tk.Y, before=self.collapse_btn)
            self.collapse_btn.config(text='â—€')
            self.left_panel_visible = True
    
    def load_sticker_images(self):
        """åŠ è½½è´´çº¸PNGå›¾ç‰‡"""
        assets_dir = os.path.join(os.path.dirname(__file__), 'assets', 'stickers')
        
        for sticker in STICKER_LIST:
            if 'file' in sticker:
                img_path = os.path.join(assets_dir, sticker['file'])
                if os.path.exists(img_path):
                    try:
                        # åŠ è½½å¹¶è°ƒæ•´å¤§å°
                        img = Image.open(img_path).convert('RGBA')
                        img = img.resize((32, 32), Image.Resampling.LANCZOS)
                        photo = ImageTk.PhotoImage(img)
                        self.sticker_images[sticker['id']] = photo
                        self.sticker_photo_refs.append(photo)  # ä¿æŒå¼•ç”¨
                    except Exception as e:
                        print(f"åŠ è½½è´´çº¸å¤±è´¥ {sticker['file']}: {e}")
    
    def load_border_preview_images(self):
        """åŠ è½½è¾¹æ¡†é¢„è§ˆå›¾"""
        frames_dir = os.path.join(os.path.dirname(__file__), 'assets', 'borders', 'frames')
        
        if not os.path.exists(frames_dir):
            return
        
        # åŠ è½½æ‰€æœ‰è¾¹æ¡†é¢„è§ˆå›¾
        for filename in os.listdir(frames_dir):
            if filename.endswith('.png'):
                try:
                    img_path = os.path.join(frames_dir, filename)
                    img = Image.open(img_path).convert('RGBA')
                    # ç¼©å°åˆ°ç¼©ç•¥å›¾å°ºå¯¸
                    img.thumbnail((60, 60), Image.Resampling.LANCZOS)
                    photo = ImageTk.PhotoImage(img)
                    border_id = filename.replace('.png', '')
                    self.border_preview_images[border_id] = photo
                    self.border_photo_refs.append(photo)
                except Exception as e:
                    print(f"åŠ è½½è¾¹æ¡†é¢„è§ˆå¤±è´¥ {filename}: {e}")
    
    def create_left_panel(self, parent):
        """åˆ›å»ºå·¦ä¾§é¢æ¿ - æ¯›ç»ç’ƒé£æ ¼"""
        panel = tk.Frame(
            parent, 
            bg=COLORS['panel_bg'], 
            width=280,
            relief=tk.FLAT,
            bd=0,
            highlightthickness=1,
            highlightbackground=COLORS['separator'],
            highlightcolor=COLORS['separator']
        )
        
        # å°ºå¯¸é€‰æ‹© - ç°ä»£é£æ ¼
        size_label = tk.Label(
            panel,
            text='é€‰æ‹©å°ºå¯¸',
            font=('SF Pro Display', 13, 'bold'),
            bg=COLORS['panel_bg'],
            fg=COLORS['text_primary'],
            anchor='w'
        )
        size_label.pack(fill=tk.X, padx=16, pady=(16, 8))
        
        size_frame = tk.Frame(panel, bg=COLORS['panel_bg'])
        size_frame.pack(fill=tk.X, padx=12, pady=(0, 12))
        
        for preset in SIZE_PRESETS:
            btn = tk.Button(
                size_frame,
                text=f"{preset['name']}\n{preset['width']}Ã—{preset['height']}",
                command=lambda p=preset: self.select_size_preset(p),
                bg='white',
                fg=COLORS['text_primary'],
                activebackground=COLORS['hover'],
                relief=tk.FLAT,
                font=('SF Pro Text', 11),
                pady=12,
                bd=0,
                highlightthickness=1,
                highlightbackground=COLORS['separator'],
                highlightcolor=COLORS['accent'],
                cursor='hand2'
            )
            btn.pack(fill=tk.X, padx=4, pady=3)
            
            # é¼ æ ‡æ‚¬åœæ•ˆæœ
            def on_enter(e, b=btn):
                b.config(bg=COLORS['hover'])
            def on_leave(e, b=btn):
                b.config(bg='white')
            btn.bind('<Enter>', on_enter)
            btn.bind('<Leave>', on_leave)
        
        # åˆ†éš”çº¿
        separator1 = tk.Frame(panel, bg=COLORS['separator'], height=1)
        separator1.pack(fill=tk.X, padx=16, pady=8)
        
        # ä¸Šä¼ å›¾ç‰‡ - ç°ä»£é£æ ¼
        upload_label = tk.Label(
            panel,
            text='å›¾ç‰‡æ“ä½œ',
            font=('SF Pro Display', 13, 'bold'),
            bg=COLORS['panel_bg'],
            fg=COLORS['text_primary'],
            anchor='w'
        )
        upload_label.pack(fill=tk.X, padx=16, pady=(8, 8))
        
        upload_frame = tk.Frame(panel, bg=COLORS['panel_bg'])
        upload_frame.pack(fill=tk.X, padx=12, pady=(0, 12))
        
        upload_btn = tk.Button(
            upload_frame,
            text='ğŸ“ ä¸Šä¼ å›¾ç‰‡',
            command=self.upload_image,
            bg=COLORS['accent'],
            fg='white',
            activebackground='#0051D5',
            font=('SF Pro Text', 12, 'bold'),
            pady=12,
            relief=tk.FLAT,
            bd=0,
            cursor='hand2'
        )
        upload_btn.pack(fill=tk.X, padx=4, pady=3)
        
        reset_btn = tk.Button(
            upload_frame,
            text='ğŸ”„ é‡ç½®å›¾ç‰‡',
            command=self.reset_image,
            bg='white',
            fg=COLORS['text_primary'],
            activebackground=COLORS['hover'],
            font=('SF Pro Text', 12),
            pady=12,
            relief=tk.FLAT,
            bd=0,
            highlightthickness=1,
            highlightbackground=COLORS['separator'],
            cursor='hand2'
        )
        reset_btn.pack(fill=tk.X, padx=4, pady=3)
        
        
        return panel
    
    def create_center_panel(self, parent):
        """åˆ›å»ºä¸­é—´ç”»å¸ƒé¢æ¿ - æ¯›ç»ç’ƒé£æ ¼"""
        panel = tk.Frame(
            parent,
            bg=COLORS['panel_bg'],
            relief=tk.FLAT,
            bd=0,
            highlightthickness=1,
            highlightbackground=COLORS['separator']
        )
        
        # å·¥å…·æ  - ç°ä»£é£æ ¼
        toolbar = tk.Frame(panel, bg=COLORS['panel_bg'], height=56)
        toolbar.pack(fill=tk.X, padx=12, pady=12)
        
        # å·¦ä¾§æŒ‰é’®
        left_buttons = tk.Frame(toolbar, bg=COLORS['panel_bg'])
        left_buttons.pack(side=tk.LEFT)
        
        btn_undo = tk.Button(
            left_buttons,
            text='â†¶ æ’¤é”€',
            command=self.undo,
            font=('SF Pro Text', 11),
            bg='white',
            fg=COLORS['text_primary'],
            activebackground=COLORS['hover'],
            relief=tk.FLAT,
            bd=0,
            padx=16,
            pady=8,
            highlightthickness=1,
            highlightbackground=COLORS['separator'],
            cursor='hand2'
        )
        btn_undo.pack(side=tk.LEFT, padx=(0, 6))
        
        btn_redo = tk.Button(
            left_buttons,
            text='â†· é‡åš',
            command=self.redo,
            font=('SF Pro Text', 11),
            bg='white',
            fg=COLORS['text_primary'],
            activebackground=COLORS['hover'],
            relief=tk.FLAT,
            bd=0,
            padx=16,
            pady=8,
            highlightthickness=1,
            highlightbackground=COLORS['separator'],
            cursor='hand2'
        )
        btn_redo.pack(side=tk.LEFT, padx=(0, 6))
        
        btn_delete = tk.Button(
            left_buttons,
            text='ğŸ—‘ï¸ åˆ é™¤è´´çº¸',
            command=self.delete_selected_sticker,
            font=('SF Pro Text', 11),
            bg='white',
            fg=COLORS['danger'],
            activebackground='#FFE5E5',
            relief=tk.FLAT,
            bd=0,
            padx=16,
            pady=8,
            highlightthickness=1,
            highlightbackground=COLORS['separator'],
            cursor='hand2'
        )
        btn_delete.pack(side=tk.LEFT)
        
        # å³ä¾§å¯¼å‡ºæŒ‰é’®
        btn_export = tk.Button(
            toolbar,
            text='ğŸ’¾ å¯¼å‡ºå›¾ç‰‡',
            command=self.export_image,
            bg=COLORS['success'],
            fg='white',
            activebackground='#28A745',
            font=('SF Pro Text', 12, 'bold'),
            relief=tk.FLAT,
            bd=0,
            padx=20,
            pady=10,
            cursor='hand2'
        )
        btn_export.pack(side=tk.RIGHT)
        
        # ç”»å¸ƒ
        self.canvas_widget = CanvasWidget(
            panel,
            width=self.current_size_preset['width'],
            height=self.current_size_preset['height']
        )
        self.canvas_widget.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        return panel
    
    def create_right_panel(self, parent):
        """åˆ›å»ºå³ä¾§é¢æ¿ - æ ‡ç­¾é¡µå¸ƒå±€ - æ¯›ç»ç’ƒé£æ ¼"""
        panel = tk.Frame(
            parent,
            bg=COLORS['panel_bg'],
            width=320,
            relief=tk.FLAT,
            bd=0,
            highlightthickness=1,
            highlightbackground=COLORS['separator']
        )
        
        # é…ç½® ttk æ ‡ç­¾é¡µæ ·å¼
        style = ttk.Style()
        style.theme_use('default')
        
        # é…ç½®æ ‡ç­¾é¡µæ ·å¼ - macOS é£æ ¼
        style.configure(
            'TNotebook',
            background=COLORS['panel_bg'],
            borderwidth=0,
            relief='flat'
        )
        style.configure(
            'TNotebook.Tab',
            background='white',
            foreground=COLORS['text_secondary'],
            padding=[20, 10],
            font=('SF Pro Text', 11),
            borderwidth=0
        )
        style.map(
            'TNotebook.Tab',
            background=[('selected', COLORS['panel_bg'])],
            foreground=[('selected', COLORS['accent'])],
            expand=[('selected', [1, 1, 1, 0])]
        )
        
        # åˆ›å»ºæ ‡ç­¾é¡µ
        notebook = ttk.Notebook(panel, style='TNotebook')
        notebook.pack(fill=tk.BOTH, expand=True, padx=0, pady=0)
        
        # æ ‡ç­¾é¡µ1: èƒŒæ™¯
        background_tab = tk.Frame(notebook, bg=COLORS['panel_bg'])
        notebook.add(background_tab, text='ğŸ¨ èƒŒæ™¯')
        self.create_background_tab(background_tab)
        
        # æ ‡ç­¾é¡µ2: è¾¹æ¡†
        border_tab = tk.Frame(notebook, bg=COLORS['panel_bg'])
        notebook.add(border_tab, text='ğŸ–¼ï¸ è¾¹æ¡†')
        self.create_border_tab(border_tab)
        
        # æ ‡ç­¾é¡µ3: è´´çº¸
        sticker_tab = tk.Frame(notebook, bg=COLORS['panel_bg'])
        notebook.add(sticker_tab, text='âœ¨ è´´çº¸')
        self.create_sticker_tab(sticker_tab)
        
        # æ ‡ç­¾é¡µ4: åŸºç¡€ç¼–è¾‘
        basic_tab = tk.Frame(notebook, bg=COLORS['panel_bg'])
        notebook.add(basic_tab, text='ğŸ“ ç¼–è¾‘')
        self.create_basic_tools_tab(basic_tab)
        
        # æ ‡ç­¾é¡µ5: æ‰¹é‡
        batch_tab = tk.Frame(notebook, bg=COLORS['panel_bg'])
        notebook.add(batch_tab, text='âš¡ æ‰¹é‡')
        self.create_batch_tab(batch_tab)
        
        return panel
    
    def create_basic_tools_tab(self, parent):
        """åŸºç¡€å·¥å…·æ ‡ç­¾é¡µ - ç°ä»£é£æ ¼"""
        # å›¾ç‰‡æ“ä½œæ ‡é¢˜
        img_label = tk.Label(
            parent,
            text='å›¾ç‰‡æ“ä½œ',
            font=('SF Pro Display', 13, 'bold'),
            bg=COLORS['panel_bg'],
            fg=COLORS['text_primary'],
            anchor='w'
        )
        img_label.pack(fill=tk.X, padx=16, pady=(16, 12))
        
        img_frame = tk.Frame(parent, bg=COLORS['panel_bg'])
        img_frame.pack(fill=tk.X, padx=12, pady=(0, 12))
        
        tools = [
            ('â†º é€†æ—¶é’ˆæ—‹è½¬90Â°', lambda: self.rotate_image(-90)),
            ('â†» é¡ºæ—¶é’ˆæ—‹è½¬90Â°', lambda: self.rotate_image(90)),
            ('â‡„ æ°´å¹³ç¿»è½¬', lambda: self.flip_image('horizontal')),
            ('â‡… å‚ç›´ç¿»è½¬', lambda: self.flip_image('vertical')),
        ]
        
        for text, command in tools:
            btn = tk.Button(
                img_frame,
                text=text,
                command=command,
                bg='white',
                fg=COLORS['text_primary'],
                activebackground=COLORS['hover'],
                font=('SF Pro Text', 11),
                pady=12,
                relief=tk.FLAT,
                bd=0,
                highlightthickness=1,
                highlightbackground=COLORS['separator'],
                cursor='hand2'
            )
            btn.pack(fill=tk.X, padx=4, pady=3)
        
        # æç¤ºä¿¡æ¯
        tip_label = tk.Label(
            parent,
            text='ğŸ’¡ æç¤ºï¼šç‚¹å‡»ç”»å¸ƒä¸Šçš„è´´çº¸å¯æ‹–æ‹½ç§»åŠ¨',
            font=('SF Pro Text', 10),
            fg=COLORS['text_secondary'],
            bg=COLORS['panel_bg'],
            wraplength=280,
            justify='left'
        )
        tip_label.pack(fill=tk.X, padx=16, pady=24)
    
    def create_decoration_tab(self, parent):
        """è£…é¥°æ ‡ç­¾é¡µ - ç°ä»£é£æ ¼"""
        # è´´çº¸éƒ¨åˆ†
        sticker_label = tk.Label(
            parent,
            text='è´´çº¸',
            font=('SF Pro Display', 13, 'bold'),
            bg=COLORS['panel_bg'],
            fg=COLORS['text_primary'],
            anchor='w'
        )
        sticker_label.pack(fill=tk.X, padx=16, pady=(16, 8))
        
        # è´´çº¸ç½‘æ ¼
        sticker_grid = tk.Frame(parent, bg=COLORS['panel_bg'])
        sticker_grid.pack(fill=tk.X, padx=12, pady=(0, 16))
        
        for idx, sticker in enumerate(STICKER_LIST):
            row = idx // 4
            col = idx % 4
            
            # ä¼˜å…ˆä½¿ç”¨PNGå›¾ç‰‡ï¼Œå¦åˆ™ä½¿ç”¨emoji
            if sticker['id'] in self.sticker_images:
                # ä½¿ç”¨PNGå›¾ç‰‡
                btn = tk.Button(
                    sticker_grid,
                    image=self.sticker_images[sticker['id']],
                    command=lambda s=sticker: self.add_sticker(s),
                    bg='white',
                    activebackground=COLORS['hover'],
                    relief=tk.FLAT,
                    width=40,
                    height=40,
                    bd=0,
                    highlightthickness=1,
                    highlightbackground=COLORS['separator'],
                    cursor='hand2'
                )
            else:
                # ä½¿ç”¨emoji
                btn = tk.Button(
                    sticker_grid,
                    text=sticker['emoji'],
                    font=('Apple Color Emoji', 28),
                    command=lambda s=sticker: self.add_sticker(s),
                    bg='white',
                    activebackground=COLORS['hover'],
                    relief=tk.FLAT,
                    width=2,
                    height=1,
                    bd=0,
                    highlightthickness=1,
                    highlightbackground=COLORS['separator'],
                    cursor='hand2'
                )
            btn.grid(row=row, column=col, padx=4, pady=4)
        
        # åˆ†éš”çº¿
        separator = tk.Frame(parent, bg=COLORS['separator'], height=1)
        separator.pack(fill=tk.X, padx=16, pady=12)
        
        # è¾¹æ¡†éƒ¨åˆ†
        border_label = tk.Label(
            parent,
            text='è¾¹æ¡†',
            font=('SF Pro Display', 13, 'bold'),
            bg=COLORS['panel_bg'],
            fg=COLORS['text_primary'],
            anchor='w'
        )
        border_label.pack(fill=tk.X, padx=16, pady=(8, 8))
        
        # è¾¹æ¡†åˆ†ç±»é€‰æ‹©
        category_frame = tk.Frame(parent, bg=COLORS['panel_bg'])
        category_frame.pack(fill=tk.X, padx=16, pady=(0, 8))
        
        self.border_category_buttons = {}
        for category_id, category_info in BORDER_CATEGORIES.items():
            btn = tk.Button(
                category_frame,
                text=category_info['name'],
                command=lambda c=category_id: self.select_border_category(c),
                bg='white' if category_id == self.selected_border_category else COLORS['hover'],
                fg=COLORS['accent'] if category_id == self.selected_border_category else COLORS['text_secondary'],
                activebackground=COLORS['hover'],
                relief=tk.FLAT,
                font=('SF Pro Text', 10, 'bold' if category_id == self.selected_border_category else 'normal'),
                padx=12,
                pady=8,
                bd=0,
                highlightthickness=1,
                highlightbackground=COLORS['separator'],
                cursor='hand2'
            )
            btn.pack(side=tk.LEFT, padx=2)
            self.border_category_buttons[category_id] = btn
        
        # é¢œè‰²é€‰æ‹©
        color_label = tk.Label(
            parent,
            text='é¢œè‰²',
            font=('SF Pro Text', 11),
            bg=COLORS['panel_bg'],
            fg=COLORS['text_secondary'],
            anchor='w'
        )
        color_label.pack(fill=tk.X, padx=16, pady=(8, 4))
        
        color_grid = tk.Frame(parent, bg=COLORS['panel_bg'])
        color_grid.pack(fill=tk.X, padx=16, pady=(0, 8))
        
        self.border_color_buttons = {}
        current_category = BORDER_CATEGORIES[self.selected_border_category]
        for idx, color_id in enumerate(current_category['colors']):
            if color_id in BORDER_COLORS:
                color_info = BORDER_COLORS[color_id]
                row = idx // 6
                col = idx % 6
                
                btn = tk.Button(
                    color_grid,
                    bg=color_info['preview'],
                    activebackground=color_info['hex'],
                    relief=tk.FLAT,
                    width=3,
                    height=1,
                    bd=0,
                    highlightthickness=2 if color_id == self.selected_border_color else 1,
                    highlightbackground=COLORS['accent'] if color_id == self.selected_border_color else COLORS['separator'],
                    cursor='hand2',
                    command=lambda c=color_id: self.select_border_color(c)
                )
                btn.grid(row=row, column=col, padx=3, pady=3)
                self.border_color_buttons[color_id] = btn
        
        # è¾¹æ¡†æ ·å¼ç½‘æ ¼ï¼ˆæ»šåŠ¨ï¼‰
        style_container = tk.Frame(parent, bg=COLORS['panel_bg'])
        style_container.pack(fill=tk.BOTH, expand=True, padx=12, pady=(0, 12))
        
        style_canvas = tk.Canvas(
            style_container,
            bg=COLORS['panel_bg'],
            highlightthickness=0,
            bd=0
        )
        style_scrollbar = tk.Scrollbar(
            style_container,
            orient='vertical',
            command=style_canvas.yview
        )
        self.border_style_frame = tk.Frame(style_canvas, bg=COLORS['panel_bg'])
        
        style_canvas.create_window((0, 0), window=self.border_style_frame, anchor='nw')
        style_canvas.configure(yscrollcommand=style_scrollbar.set)
        
        # åˆå§‹åŒ–è¾¹æ¡†æ ·å¼æ˜¾ç¤º
        self.update_border_styles_display()
        
        self.border_style_frame.update_idletasks()
        style_canvas.config(scrollregion=style_canvas.bbox('all'))
        
        style_canvas.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        style_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
    
    def select_border_category(self, category_id):
        """é€‰æ‹©è¾¹æ¡†åˆ†ç±»"""
        self.selected_border_category = category_id
        
        # æ›´æ–°åˆ†ç±»æŒ‰é’®æ ·å¼
        for cat_id, btn in self.border_category_buttons.items():
            if cat_id == category_id:
                btn.config(
                    bg='white',
                    fg=COLORS['accent'],
                    font=('SF Pro Text', 10, 'bold')
                )
            else:
                btn.config(
                    bg=COLORS['hover'],
                    fg=COLORS['text_secondary'],
                    font=('SF Pro Text', 10)
                )
        
        # æ›´æ–°è¾¹æ¡†æ ·å¼æ˜¾ç¤º
        self.update_border_styles_display()
    
    def select_border_color(self, color_id):
        """é€‰æ‹©è¾¹æ¡†é¢œè‰²"""
        self.selected_border_color = color_id
        
        # æ›´æ–°é¢œè‰²æŒ‰é’®æ ·å¼
        for c_id, btn in self.border_color_buttons.items():
            if c_id == color_id:
                btn.config(highlightthickness=2, highlightbackground=COLORS['accent'])
            else:
                btn.config(highlightthickness=1, highlightbackground=COLORS['separator'])
        
        # æ›´æ–°è¾¹æ¡†æ ·å¼æ˜¾ç¤º
        self.update_border_styles_display()
    
    def update_border_styles_display(self):
        """æ›´æ–°è¾¹æ¡†æ ·å¼æ˜¾ç¤º"""
        # æ¸…ç©ºç°æœ‰å†…å®¹
        for widget in self.border_style_frame.winfo_children():
            widget.destroy()
        
        # è·å–å½“å‰åˆ†ç±»çš„æ ·å¼
        category = BORDER_CATEGORIES[self.selected_border_category]
        
        for style in category['styles']:
            # æ„å»ºè¾¹æ¡†ID
            border_id = f"{self.selected_border_category}_{style}_{self.selected_border_color}"
            
            # åˆ›å»ºè¾¹æ¡†æŒ‰é’®
            btn_frame = tk.Frame(self.border_style_frame, bg='white', highlightthickness=1, highlightbackground=COLORS['separator'])
            btn_frame.pack(fill=tk.X, padx=4, pady=4)
            
            # å¦‚æœæœ‰é¢„è§ˆå›¾ï¼Œæ˜¾ç¤ºé¢„è§ˆå›¾
            if border_id in self.border_preview_images:
                img_label = tk.Label(
                    btn_frame,
                    image=self.border_preview_images[border_id],
                    bg='white',
                    cursor='hand2'
                )
                img_label.pack(side=tk.LEFT, padx=8, pady=8)
                img_label.bind('<Button-1>', lambda e, bid=border_id: self.apply_border(bid))
            
            # æ˜¾ç¤ºè¾¹æ¡†åç§°
            name = BORDER_STYLE_NAMES.get(style, style)
            color_name = BORDER_COLORS.get(self.selected_border_color, {}).get('name', '')
            full_name = f"{name} - {color_name}"
            
            name_label = tk.Label(
                btn_frame,
                text=full_name,
                font=('SF Pro Text', 11),
                bg='white',
                fg=COLORS['text_primary'],
                anchor='w',
                cursor='hand2'
            )
            name_label.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=8, pady=12)
            name_label.bind('<Button-1>', lambda e, bid=border_id: self.apply_border(bid))
            
            # æ‚¬åœæ•ˆæœ
            def on_enter(e, frame=btn_frame):
                frame.config(bg=COLORS['hover'])
                for child in frame.winfo_children():
                    child.config(bg=COLORS['hover'])
            
            def on_leave(e, frame=btn_frame):
                frame.config(bg='white')
                for child in frame.winfo_children():
                    child.config(bg='white')
            
            btn_frame.bind('<Enter>', on_enter)
            btn_frame.bind('<Leave>', on_leave)
            for child in btn_frame.winfo_children():
                child.bind('<Enter>', on_enter)
                child.bind('<Leave>', on_leave)
    
    def apply_border(self, border_id):
        """åº”ç”¨è¾¹æ¡† - ç›´æ¥ç”Ÿæ•ˆ"""
        # è§£æborder_id: category_style_color
        parts = border_id.split('_')
        if len(parts) >= 3:
            category = parts[0]
            style = parts[1]
            color = parts[2]
            
            # åŠ è½½è¾¹æ¡†å›¾ç‰‡
            frames_dir = os.path.join(os.path.dirname(__file__), 'assets', 'borders', 'frames')
            border_path = os.path.join(frames_dir, f"{border_id}.png")
            
            if os.path.exists(border_path):
                try:
                    # åº”ç”¨åˆ°ç”»å¸ƒ
                    border_img = Image.open(border_path).convert('RGBA')
                    self.canvas_widget.apply_border_image(border_img)
                    print(f"âœ“ è¾¹æ¡†å·²åº”ç”¨: {border_id}")
                except Exception as e:
                    print(f"åº”ç”¨è¾¹æ¡†å¤±è´¥: {e}")
            else:
                print(f"è¾¹æ¡†æ–‡ä»¶ä¸å­˜åœ¨: {border_path}")
    
    def create_batch_tab(self, parent):
        """æ‰¹é‡å¤„ç†æ ‡ç­¾é¡µ - ç°ä»£é£æ ¼"""
        batch_frame = tk.Frame(parent, bg=COLORS['panel_bg'])
        batch_frame.pack(fill=tk.BOTH, expand=True, padx=16, pady=16)
        
        # è¯´æ˜æ–‡å­—
        desc_label = tk.Label(
            batch_frame,
            text='æ‰¹é‡å¤„ç†å¯å°†å½“å‰è®¾ç½®çš„è´´çº¸å’Œè¾¹æ¡†\nåº”ç”¨åˆ°å¤šå¼ å›¾ç‰‡ä¸Š',
            font=('SF Pro Text', 11),
            bg=COLORS['panel_bg'],
            fg=COLORS['text_secondary'],
            justify=tk.LEFT
        )
        desc_label.pack(pady=(0, 24))
        
        batch_upload_btn = tk.Button(
            batch_frame,
            text='ğŸ“ æ‰¹é‡ä¸Šä¼ å›¾ç‰‡',
            command=self.batch_upload,
            bg=COLORS['warning'],
            fg='white',
            activebackground='#E68A00',
            font=('SF Pro Text', 12, 'bold'),
            pady=14,
            relief=tk.FLAT,
            bd=0,
            cursor='hand2'
        )
        batch_upload_btn.pack(fill=tk.X, pady=6)
        
        self.batch_count_label = tk.Label(
            batch_frame,
            text='å·²é€‰æ‹©: 0 å¼ å›¾ç‰‡',
            bg=COLORS['panel_bg'],
            fg=COLORS['text_primary'],
            font=('SF Pro Display', 12, 'bold')
        )
        self.batch_count_label.pack(pady=12)
        
        batch_export_btn = tk.Button(
            batch_frame,
            text='âš¡ æ‰¹é‡ç”Ÿæˆå¹¶å¯¼å‡º',
            command=self.batch_export,
            bg=COLORS['success'],
            fg='white',
            activebackground='#28A745',
            font=('SF Pro Text', 12, 'bold'),
            pady=14,
            relief=tk.FLAT,
            bd=0,
            cursor='hand2'
        )
        batch_export_btn.pack(fill=tk.X, pady=6)
        
        # æ‰¹é‡å¤„ç†æç¤º
        tip_text = """
ä½¿ç”¨æ­¥éª¤ï¼š
1. å…ˆä¸Šä¼ ä¸€å¼ æ ·ä¾‹å›¾ç‰‡
2. æ·»åŠ è´´çº¸å’Œè¾¹æ¡†
3. ç‚¹å‡»"æ‰¹é‡ä¸Šä¼ å›¾ç‰‡"
4. ç‚¹å‡»"æ‰¹é‡ç”Ÿæˆ"å³å¯

æ³¨æ„ï¼šæ‰¹é‡å¤„ç†ä¼šå°†å½“å‰ç”»å¸ƒ
ä¸Šçš„è´´çº¸å’Œè¾¹æ¡†åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡
        """
        tip_label = tk.Label(
            batch_frame,
            text=tip_text,
            font=('Arial', 9),
            bg=COLORS['bg'],
            fg='#666',
            justify=tk.LEFT,
            padx=10,
            pady=10
        )
        tip_label.pack(fill=tk.X, pady=20)
    
    def select_size_preset(self, preset):
        """é€‰æ‹©å°ºå¯¸é¢„è®¾"""
        self.current_size_preset = preset
        self.image_processor.set_canvas_size(preset['width'], preset['height'])
        self.canvas_widget.resize_canvas(preset['width'], preset['height'])
        
        # å¦‚æœå·²æœ‰å›¾ç‰‡ï¼Œé‡æ–°è°ƒæ•´å¤§å°
        if self.image_processor.current_image:
            self.refresh_canvas()
        
        messagebox.showinfo('å°ºå¯¸è®¾ç½®', f"å·²è®¾ç½®ä¸º: {preset['name']}")
    
    def upload_image(self):
        """ä¸Šä¼ å›¾ç‰‡"""
        file_path = filedialog.askopenfilename(
            title='é€‰æ‹©å›¾ç‰‡',
            filetypes=[
                ('å›¾ç‰‡æ–‡ä»¶', '*.jpg *.jpeg *.png *.bmp *.gif'),
                ('æ‰€æœ‰æ–‡ä»¶', '*.*')
            ]
        )
        
        if file_path:
            if self.image_processor.load_image(file_path):
                self.image_processor.resize_to_canvas(maintain_ratio=True)
                self.refresh_canvas()
                self.save_history()
                messagebox.showinfo('æˆåŠŸ', 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼')
            else:
                messagebox.showerror('é”™è¯¯', 'å›¾ç‰‡åŠ è½½å¤±è´¥ï¼')
    
    def reset_image(self):
        """é‡ç½®å›¾ç‰‡"""
        self.image_processor.reset_image()
        if self.image_processor.current_image:
            self.image_processor.resize_to_canvas(maintain_ratio=True)
            self.refresh_canvas()
            self.save_history()
    
    def add_sticker(self, sticker):
        """æ·»åŠ è´´çº¸"""
        # å¦‚æœæœ‰PNGå›¾ç‰‡æ–‡ä»¶ï¼Œä¼˜å…ˆä½¿ç”¨å›¾ç‰‡
        sticker_path = os.path.join(os.path.dirname(__file__), 'assets', 'stickers', sticker.get('file', ''))
        if os.path.exists(sticker_path):
            try:
                # åŠ è½½PNGè´´çº¸ï¼Œä½†è¿˜æ˜¯ç”¨emojiæ˜¾ç¤ºï¼ˆå› ä¸ºcanvas_widgetå½“å‰ä½¿ç”¨emojiï¼‰
                # TODO: åç»­å¯ä»¥æ”¯æŒçœŸæ­£çš„å›¾ç‰‡è´´çº¸
                self.canvas_widget.add_sticker(sticker['emoji'], font_size=48)
            except Exception as e:
                print(f"åŠ è½½è´´çº¸å›¾ç‰‡å¤±è´¥: {e}")
                self.canvas_widget.add_sticker(sticker['emoji'], font_size=48)
        else:
            self.canvas_widget.add_sticker(sticker['emoji'], font_size=48)
        
        self.save_history()
    
    def rotate_image(self, angle):
        """æ—‹è½¬å›¾ç‰‡"""
        if self.image_processor.base_image:
            rotated = self.image_processor.base_image.rotate(angle, expand=True)
            self.image_processor.base_image = rotated
            self.image_processor.current_image = rotated
            self.image_processor.resize_to_canvas(maintain_ratio=True)
            self.refresh_canvas()
            self.save_history()
    
    def flip_image(self, direction):
        """ç¿»è½¬å›¾ç‰‡"""
        if self.image_processor.base_image:
            from PIL import Image as PILImage
            if direction == 'horizontal':
                flipped = self.image_processor.base_image.transpose(PILImage.FLIP_LEFT_RIGHT)
            else:  # vertical
                flipped = self.image_processor.base_image.transpose(PILImage.FLIP_TOP_BOTTOM)
            
            self.image_processor.base_image = flipped
            self.image_processor.current_image = flipped
            self.image_processor.resize_to_canvas(maintain_ratio=True)
            self.refresh_canvas()
            self.save_history()
    
    def select_border(self, border):
        """é€‰æ‹©è¾¹æ¡†"""
        self.current_border = border
        self.canvas_widget.add_border(border)
        self.save_history()
    
    def delete_selected_sticker(self):
        """åˆ é™¤é€‰ä¸­çš„è´´çº¸"""
        if self.canvas_widget.delete_selected_sticker():
            self.save_history()
            messagebox.showinfo('æˆåŠŸ', 'è´´çº¸å·²åˆ é™¤')
        else:
            messagebox.showwarning('æç¤º', 'è¯·å…ˆç‚¹å‡»é€‰æ‹©è¦åˆ é™¤çš„è´´çº¸')
    
    def refresh_canvas(self):
        """åˆ·æ–°ç”»å¸ƒ"""
        current_image = self.image_processor.get_current_image()
        if current_image:
            self.canvas_widget.display_image(current_image)
            self.canvas_widget.add_border(self.current_border)
    
    def export_image(self):
        """å¯¼å‡ºå›¾ç‰‡"""
        if not self.image_processor.current_image:
            messagebox.showwarning('æç¤º', 'è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼')
            return
        
        # ç”Ÿæˆé»˜è®¤æ–‡ä»¶å
        default_name = f"tupian_{datetime.now().strftime('%Y%m%d_%H%M%S')}.png"
        
        file_path = filedialog.asksaveasfilename(
            title='ä¿å­˜å›¾ç‰‡',
            defaultextension='.png',
            initialfile=default_name,
            filetypes=[
                ('PNGå›¾ç‰‡', '*.png'),
                ('JPEGå›¾ç‰‡', '*.jpg'),
                ('æ‰€æœ‰æ–‡ä»¶', '*.*')
            ]
        )
        
        if file_path:
            # ç”Ÿæˆæœ€ç»ˆå›¾ç‰‡
            composite = CompositeImage(
                self.current_size_preset['width'],
                self.current_size_preset['height']
            )
            
            # æ·»åŠ ä¸»å›¾ç‰‡
            composite.add_main_image(self.image_processor.current_image, fit_mode='contain')
            
            # æ·»åŠ è´´çº¸
            for sticker in self.canvas_widget.get_stickers():
                composite.add_sticker(sticker['text'], sticker['x'], sticker['y'], sticker['size'])
            
            # æ·»åŠ è¾¹æ¡†
            if 'rounded' in self.current_border['id']:
                composite.add_rounded_border(self.current_border)
            else:
                composite.add_border(self.current_border)
            
            # ä¿å­˜
            if composite.save(file_path):
                messagebox.showinfo('æˆåŠŸ', f'å›¾ç‰‡å·²ä¿å­˜åˆ°:\n{file_path}')
            else:
                messagebox.showerror('é”™è¯¯', 'ä¿å­˜å¤±è´¥ï¼')
    
    def batch_upload(self):
        """æ‰¹é‡ä¸Šä¼ å›¾ç‰‡"""
        file_paths = filedialog.askopenfilenames(
            title='æ‰¹é‡é€‰æ‹©å›¾ç‰‡',
            filetypes=[
                ('å›¾ç‰‡æ–‡ä»¶', '*.jpg *.jpeg *.png *.bmp *.gif'),
                ('æ‰€æœ‰æ–‡ä»¶', '*.*')
            ]
        )
        
        if file_paths:
            self.batch_images = list(file_paths)
            self.batch_count_label.config(text=f'å·²é€‰æ‹©: {len(self.batch_images)} å¼ å›¾ç‰‡')
            messagebox.showinfo('æˆåŠŸ', f'å·²é€‰æ‹© {len(self.batch_images)} å¼ å›¾ç‰‡')
    
    def batch_export(self):
        """æ‰¹é‡å¯¼å‡ºå›¾ç‰‡"""
        if not self.batch_images:
            messagebox.showwarning('æç¤º', 'è¯·å…ˆæ‰¹é‡ä¸Šä¼ å›¾ç‰‡ï¼')
            return
        
        # é€‰æ‹©è¾“å‡ºç›®å½•
        output_dir = filedialog.askdirectory(title='é€‰æ‹©è¾“å‡ºç›®å½•')
        if not output_dir:
            return
        
        success_count = 0
        
        for idx, img_path in enumerate(self.batch_images):
            try:
                # åŠ è½½å›¾ç‰‡
                processor = ImageProcessor()
                processor.load_image(img_path)
                processor.set_canvas_size(
                    self.current_size_preset['width'],
                    self.current_size_preset['height']
                )
                processor.resize_to_canvas(maintain_ratio=True)
                
                # ç”Ÿæˆå¤åˆå›¾ç‰‡
                composite = CompositeImage(
                    self.current_size_preset['width'],
                    self.current_size_preset['height']
                )
                composite.add_main_image(processor.current_image, fit_mode='contain')
                
                # æ·»åŠ è´´çº¸ï¼ˆä½¿ç”¨å½“å‰ç”»å¸ƒçš„è´´çº¸ï¼‰
                for sticker in self.canvas_widget.get_stickers():
                    composite.add_sticker(sticker['text'], sticker['x'], sticker['y'], sticker['size'])
                
                # æ·»åŠ è¾¹æ¡†
                if 'rounded' in self.current_border['id']:
                    composite.add_rounded_border(self.current_border)
                else:
                    composite.add_border(self.current_border)
                
                # ä¿å­˜
                filename = f"processed_{idx+1}_{os.path.basename(img_path)}"
                output_path = os.path.join(output_dir, filename)
                
                if composite.save(output_path):
                    success_count += 1
                
            except Exception as e:
                print(f"å¤„ç†å›¾ç‰‡ {img_path} å¤±è´¥: {e}")
        
        messagebox.showinfo('å®Œæˆ', f'æ‰¹é‡å¤„ç†å®Œæˆï¼\næˆåŠŸ: {success_count}/{len(self.batch_images)}')
    
    def save_history(self):
        """ä¿å­˜å†å²è®°å½•"""
        # ç®€å•çš„å†å²è®°å½•å®ç°
        pass
    
    def undo(self):
        """æ’¤é”€"""
        messagebox.showinfo('æç¤º', 'æ’¤é”€åŠŸèƒ½å¼€å‘ä¸­...')
    
    def redo(self):
        """é‡åš"""
        messagebox.showinfo('æç¤º', 'é‡åšåŠŸèƒ½å¼€å‘ä¸­...')
